package lol.nebula.module.exploit;

import lol.nebula.listener.bus.Listener;
import lol.nebula.listener.events.entity.EventDecrementPotion;
import lol.nebula.listener.events.net.EventPacket;
import lol.nebula.module.Module;
import lol.nebula.module.ModuleCategory;
import lol.nebula.util.player.MoveUtils;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;

/**
 * @author aesthetical
 * @since 04/30/23
 */
public class PotionSaver extends Module {
    private int lagTicks = 0;

    public PotionSaver() {
        super("Potion Saver", "Prevents waste of potions when standing still", ModuleCategory.EXPLOIT);
    }

    @Override
    public void onDisable() {
        super.onDisable();
        lagTicks = 0;
    }

    @Listener
    public void onPacketInbound(EventPacket.Inbound event) {
        if (event.getPacket() instanceof S08PacketPlayerPosLook) {
            lagTicks = 20;
        }
    }

    @Listener
    public void onPacketOutbound(EventPacket.Outbound event) {
        if (event.getPacket() instanceof C03PacketPlayer) {

            // do not send movement update packets if we are not moving, or we aren't jumping
            if (shouldCancel()) event.cancel();
        }
    }

    @Listener
    public void onDecrementPotion(EventDecrementPotion event) {

        // do not decrement the potion duration if we are canceling C03s
        if (shouldCancel()) event.cancel();
    }

    /**
     * Checks if we should cancel movement update packets
     * @return if we are not moving and are not pressing jump
     */
    private boolean shouldCancel() {
        if (mc.thePlayer.ticksExisted < 10 || --lagTicks > 0) return false;
        return MoveUtils.getSpeed() == 0.0 && !mc.gameSettings.keyBindJump.pressed;
    }

}
